# segment.bytes of Kafka's Topics

การพิจารณาขนาด segment ที่เหมาะสมขึ้นอยู่กับหลายปัจจัย โดยเฉพาะลักษณะของข้อมูลและความต้องการในการใช้งาน สำหรับกรณี (Avg message size 250 bytes และ 8 TPS) วิเคราะห์และคำนวณ:

1. คำนวณปริมาณข้อมูลต่อวัน:
   * ข้อมูลต่อวินาที = 250 bytes * 8 TPS = 2,000 bytes/second
   * ข้อมูลต่อวัน = 2,000 * 60 * 60 * 24 = 172,800,000 bytes/day ≈ 165 MB/day

2. พิจารณา Retention:
   * หากต้องการ retention 7 วัน, ข้อมูลทั้งหมดจะประมาณ 165 MB * 7 ≈ 1.16 GB

3. พิจารณาขนาด Segment:
   * ทั่วไปแล้ว ควรตั้งค่า segment.bytes ให้เล็กกว่าขนาดข้อมูลทั้งหมดที่ต้องการเก็บ
   * ควรพิจารณาให้ segment มีขนาดที่ทำให้สามารถลบข้อมูลได้ใกล้เคียงกับ retention.ms ที่ต้องการ

4. คำนวณขนาด Segment ที่เหมาะสม:
   * เพื่อให้สามารถลบข้อมูลได้ใกล้เคียงรายวัน, อาจพิจารณาตั้ง segment.bytes ประมาณ 1-2 เท่าของข้อมูลต่อวัน
   * ในกรณีนี้, อาจตั้ง segment.bytes ประมาณ 165-330 MB

5. ข้อพิจารณาเพิ่มเติม:
   * ถ้าต้องการ retention ที่แม่นยำมาก อาจลดขนาด segment ลงอีก เช่น ครึ่งวันหรือ 1/4 ของวัน
   * ถ้าคำนึงถึงประสิทธิภาพการเขียนมากกว่า อาจเพิ่มขนาด segment ให้ใหญ่ขึ้น

คำแนะนำ:
ในกรณีนี้, แนะนำให้ตั้งค่า `segment.bytes` ประมาณ 200-250 MB ซึ่งจะทำให้:
- สามารถลบข้อมูลได้ค่อนข้างแม่นยำตาม retention policy
- มี segments จำนวนพอเหมาะ ไม่มากหรือน้อยเกินไป
- ใช้ทรัพยากรในการจัดการ segments อย่างมีประสิทธิภาพ

>ตัวอย่างคำสั่งในการปรับ segment.bytes:

```bash
.\bin\kafka-configs.sh --bootstrap-server kafka.abc.xxx:9092 \
--alter \
--entity-type topics \
--entity-name test1 \
--add-config segment.bytes=262144000 \
--command-config admin-client.properties
```
คำสั่งนี้จะตั้งค่า `segment.bytes` เป็น 250 MB (262,144,000 bytes)

>และตัวอย่างคำสั่งตรวจสอบค่า Topic

```bash
kafka-topics --describe --topic test1 \
--bootstrap-server kafka.abc.xxx:9092 \
--command-config admin-client.properties
```

---

### อธิบายการคำนวณและเหตุผลให้ชัดเจน:

1. ข้อมูลพื้นฐาน:
   - ข้อมูลต่อวัน = 165 MB

2. การพิจารณา:
   a) ถ้าต้องการ retention ที่แม่นยำมาก:
      - อาจใช้ขนาด segment เท่ากับข้อมูลครึ่งวัน: 165 MB / 2 ≈ 82.5 MB
      - หรือ 1/4 ของวัน: 165 MB / 4 ≈ 41.25 MB

   b) ถ้าคำนึงถึงประสิทธิภาพการเขียน:
      - อาจใช้ขนาด segment เท่ากับข้อมูล 1-2 วัน: 165-330 MB

3. การสมดุล:
   - เราต้องการสมดุลระหว่างความแม่นยำของ retention และประสิทธิภาพการเขียน
   - ขนาด 250 MB เป็นค่าที่อยู่ระหว่างกลางของทั้งสองแนวทาง

4. เหตุผลในการเลือก 250 MB:
   - ใหญ่กว่าข้อมูล 1 วัน เล็กน้อย (165 MB) เพื่อรองรับความผันผวนของปริมาณข้อมูล
   - เล็กกว่าข้อมูล 2 วัน (330 MB) เพื่อให้สามารถลบข้อมูลได้ค่อนข้างแม่นยำ
   - เป็นตัวเลขกลมที่ง่ายต่อการจดจำและจัดการ

5. การปรับแต่งเพิ่มเติม:
   - หากพบว่า retention ไม่แม่นยำพอ อาจลดลงเป็น 200 MB หรือ 165 MB
   - หากพบว่าประสิทธิภาพการเขียนไม่ดีพอ อาจเพิ่มเป็น 300 MB หรือ 330 MB

สรุป:
การแนะนำ 250 MB เป็นจุดเริ่มต้นที่สมเหตุสมผล โดยพิจารณาจากปริมาณข้อมูลต่อวันและพยายามสมดุลระหว่างความแม่นยำของ retention กับประสิทธิภาพการเขียน อย่างไรก็ตาม การตั้งค่าที่เหมาะสมที่สุดอาจต้องมีการทดสอบและปรับแต่งในสภาพแวดล้อมจริง

---